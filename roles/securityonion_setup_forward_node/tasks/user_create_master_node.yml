---

- name: Create a User {{ansible_user}} in Master Node # crea un usuario en el master del mismo nombre
  expect: 
   command: ssh -t "{{ SSH_USERNAME }}"@"{{ SERVERNAME }}" 'sudo useradd -m {{ansible_user}}'
   responses:
     'password': "{{ so_ssh_master_password }}"
     'Are you sure you want to continue connecting.': "yes"
  ignore_errors: True
  register: user_exists

#- debug:
#   msg: "{{ user_exists }}"


## SI EL USUARIO NO EXISTE LO CREA 


- name: Create a password for user {{ansible_user}} in Master Node
  expect:
   command: ssh -t "{{ SSH_USERNAME }}"@"{{ SERVERNAME }}" 'sudo passwd {{ansible_user}}'
   responses:
     '^(?!.*\bUNIX\b)(?=.*\bpassword\b).*$': "{{ so_ssh_master_password }}"  #MATCHEA SI NO CONTIENE UNIX y si contiene password
     'UNIX password': "{{ so_ssh_foward_pass_to_master }}" #contraseña creada
     'Are you sure you want to continue connecting.': "yes"
  when: user_exists.rc == 0

- name: Add user {{ansible_user}} to the Sudo group in Master Node
  expect: 
   command: ssh -t "{{ SSH_USERNAME }}"@"{{ SERVERNAME }}" 'sudo adduser {{ansible_user}} sudo'
   responses:
     'password': "{{ so_ssh_master_password }}" 
     'Are you sure you want to continue connecting.': "yes"
  when:  user_exists.rc == 0

- name: Add user "{{ansible_user}}" to the Sudo group in Master Node
  expect: 
   command: >
      ssh -t "{{ SSH_USERNAME }}"@"{{ SERVERNAME }}" 'sudo bash -c "echo '{{ ansible_user }} ALL=NOPASSWD: ALL' > /etc/sudoers.d/temp-sudo-{{ ansible_user }}"'
   responses:
     'password': "{{ so_ssh_master_password }}" 
     'Are you sure you want to continue connecting.': "yes"
  when:  user_exists.rc == 0


## SI EL USUARIO EXISTE VERIFICA SI EL PASSWORD BRINDADO ES VALIDO PARA EL USUARIO

- name: Verify password to  user {{ansible_user}} in Master Node
  expect: 
   command: ssh -t "{{ ansible_user }}"@"{{ SERVERNAME }}" 'sudo -v'
   responses:
     'password': "{{ so_ssh_foward_pass_to_master }}" 
     'Are you sure you want to continue connecting.': "yes"
  register: password_validation
  ignore_errors: True
  when: user_exists.rc != 0


#- debug: 
#   msg: "{{ password_validation }}"

- fail:
    msg: El usuario "{{ ansible_user }}" que existe en el Master tiene una contraseña distinta a la ingresada.
  when: password_validation.rc != 0

- name: Add or verify if user {{ansible_user}} i the Sudo group in Master Node
  expect: 
   command: ssh -t "{{ SSH_USERNAME }}"@"{{ SERVERNAME }}" 'sudo adduser {{ansible_user}} sudo'
   responses:
     'password': "{{ so_ssh_master_password }}" 
     'Are you sure you want to continue connecting.': "yes"
  when: user_exists.rc != 0

- name: Add user "{{ansible_user}}" to the Sudo group in Master Node
  expect: 
   command: >
      ssh -t "{{ SSH_USERNAME }}"@"{{ SERVERNAME }}" 'sudo bash -c "echo '{{ ansible_user }} ALL=NOPASSWD: ALL' > /etc/sudoers.d/temp-sudo-{{ ansible_user }}"'
   responses:
     'password': "{{ so_ssh_master_password }}" 
     'Are you sure you want to continue connecting.': "yes"
  when:  user_exists.rc != 0


 
 
 
